<?php
	#if(file_exists("nucleo/general.php")) require_once("nucleo/general.php");
	
	if(@file_exists("nucleo/GeometryLibrary/vendor/autoload.php"))			require_once("nucleo/GeometryLibrary/vendor/autoload.php");
	if(@file_exists("../nucleo/GeometryLibrary/vendor/autoload.php"))		require_once("../nucleo/GeometryLibrary/vendor/autoload.php");
	if(@file_exists("../../nucleo/GeometryLibrary/vendor/autoload.php"))	require_once("../../nucleo/GeometryLibrary/vendor/autoload.php");				
	
	class position extends general
	{   
		##############################################################################	
		##  Propiedades	
		##############################################################################
		var $noactualizar	=array("stop");
		var $sys_fields		=array(
			"id"	    =>array(
			    "title"             => "id",
			    "showTitle"         => "si",
			    "type"              => "primary key",
			    "default"           => "",
			    "value"             => "",			    
			),		
			"devicetime"	    =>array(
			    "title"             => "Hora",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",
			    
			),			
			"protocol"	    =>array(
			    "title"             => "Protocolo",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",
			    
			),
			"deviceid"	    =>array(
			    "title"             => "Dispositivo",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",
			),						
			"latitude"	    =>array(
			    "title"             => "Latitud",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			"longitude"	    =>array(
			    "title"             => "Longitud",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			"altitude"	    =>array(
			    "title"             => "Altura",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			"speed_max"	    =>array(
			    "title"             => "Velocidad Maxima",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			"speed_start"	    =>array(
			    "title"             => "Velocidad Inicio",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			"speed_end"	    =>array(
			    "title"             => "Velocidad Fin",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						

			"course"	    =>array(
			    "title"             => "Curso",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			    "value"             => "",
			),						
			"address"	    =>array(
			    "title"             => "Localizacion",
			    "showTitle"         => "si",
			    "type"              => "font",
			    "default"           => "",
			    "value"             => "",
			),						
			
			"ubicacion"	    =>array(
			    "title"             => "Ubicacion",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",

			),	
			"leido"	    =>array(
			    "title"             => "leido",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",

			),
			"event"	    =>array(
			    "title"             => "Evento",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",

			),	
			"geofence"	    =>array(
			    "title"             => "Geocerca",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",

			),
		);				
		##############################################################################	
		##  Metodos	
		##############################################################################

        
		public function __CONSTRUCT()
		{
			$this->sys_table="positions";
			parent::__CONSTRUCT();
		}
		
		public function __SAVE($datas=NULL,$option=NULL)
    	{    		
    		#echo "<br>SAVE MODULO";
    		#$this->__PRINT_R($datas);    		
    		parent::__SAVE($datas,$option);
    		
		}	
		public function cron_retraso()
    	{			    		
			$comando_sql="
				SELECT * FROM V_ULTIMOREPORTE 
				WHERE 1=1
					AND tipo_vehiculo='GPS'
					AND reporto_hace>'00:05:00'
			";
			$position_data 		=$this->__EXECUTE($comando_sql);
			if(count($position_data)>0)
			{
				$comando_sql		="INSERT INTO logs SET text='RETARDO DE ". count($position_data) ."'";
				$this->__EXECUTE($comando_sql);
				
				$devices_tr			="<tr><td>Status</td><td>Dispositivo</td><td>Empresa</td><td>Tiempo</td></tr>";			
				
				foreach($position_data as $row)
				{
					$devices_tr		.="<tr><td><img src=\"http://solesgps.com/modulos/execute/status_device.php?ID={$row["ID"]}\"></td><td>{$row["NOMBRE"]}</td><td>{$row["EMPRESA"]}</td><td>{$row["REPORTO_HACE"]}</td><td>{$row["TELEFONO"]}</td></tr>";
				}
				$mensaje   = "
					<html>
						<body>
							CRONS RETRASO
							<table>	$devices_tr </table>
						</body>	
					</html>				
				";								
				$this->sys_date					=date("Y-m-d H:i:s");
				$option=array(
					"to"	=>"evigra@gmail.com, daniel.dazaet@gmail.com,judith.avi03@gmail.com",
					"title"	=>"SOLESGPS ".$this->date." :: Dispositivos Retrasados",										
					"html"	=>"$mensaje",			
				);				
				$this->send_mail($option);				
			}						
		}
		public function cron_delete_position()
    	{			    		
			$comando_sql="
				delete from positions
				where deviceTime<date_sub(NOW(), INTERVAL (
					SELECT 
						case 
							when history is NULL then 45 
							else history  
						end 
					FROM devices d 
					WHERE d.id=positions.deviceId
				) DAY); 
			";
			$position_data 		=$this->__EXECUTE($comando_sql);
		}

		public function cron_distance()
    	{			    		
			$comando_sql="
				insert into odometer (device_id,start,end,distance,date)
				select 	
					d.id as dev_id,    
					min(truncate((extract_JSON(p.attributes,'totalDistance') + d.odometro_inicial)/1000,1)) as inicial,
					max(truncate((extract_JSON(p.attributes,'totalDistance') + d.odometro_inicial)/1000,1)) as final,
					max(truncate((extract_JSON(p.attributes,'totalDistance') + d.odometro_inicial)/1000,1)) -
					min(truncate((extract_JSON(p.attributes,'totalDistance') + d.odometro_inicial)/1000,1)) as distance,
					left(DATE_SUB(p.devicetime,INTERVAL 6 HOUR),10) as fecha    
				from 
					positions p join 
					devices d on p.deviceId=d.id 
				where 	1=1				
					and extract_JSON(p.attributes,'totalDistance') > 0    
					and left(DATE_SUB(p.devicetime,INTERVAL 6 HOUR),10) > left(DATE_SUB(now(),INTERVAL 2 day),10)
					and left(DATE_SUB(now(),INTERVAL 1 day),10) = left(DATE_SUB(p.devicetime,INTERVAL 6 HOUR),10)
				group by dev_id, left(DATE_SUB(p.devicetime,INTERVAL 6 HOUR),10)
				having distance>0			
			";
			$position_data 		=$this->__EXECUTE($comando_sql);
		}

		public function cron_position()
    	{			 
    		$descripcion="";
			$comando_sql="
				select p.*,
					p.id as pos_id,
					d.id as dev_id,
					DATE_SUB(p.devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR) as devicetime,
					c.*,
					f.*,
					d.*,
					d.name as dispo,
					CASE 
						WHEN protocol='meitrack' 	THEN EXTRACT_JSON(p.attributes,'event')
						WHEN protocol='gps103' 		THEN EXTRACT_JSON(p.attributes,'alarm')					
						WHEN protocol='osmand' 		THEN 'REPORTE DE TIEMPO'
						WHEN protocol='h02' 		THEN 'REPORTE DE TIEMPO'
                        else  'REPORTE DE TIEMPO'
					END
                    as cve_evento,
					CASE 
						WHEN e.descripcion IS NOT NULL THEN e.descripcion
                        else 'REPORTE DE TIEMPO'
					END	 as event 
				from 
					positions p left join 
					event e on 
					CASE
						WHEN protocol='meitrack' 		THEN leido=0 AND p.protocol=e.protocolo AND EXTRACT_JSON(p.attributes,'event')=e.codigo
						WHEN protocol='gps103' 			THEN leido=0 AND p.protocol=e.protocolo AND EXTRACT_JSON(p.attributes,'alarm')=e.codigo
                        WHEN protocol='osmand' 			THEN leido=0 AND p.protocol=e.protocolo
                        WHEN protocol='h02' 			THEN leido=0 
                    END left join
                    devices d on p.deviceid=d.id join
                    company c on d.company_id=c.id left join
                    files f on c.files_id=f.id
				where 1=1					
					AND leido=0
					AND protocol in ('meitrack','gps103','osmand','h02','')
				LIMIT 1000
			";		

			#echo "<br>$comando_sql"; # AND event not in ('REPORTE DE TIEMPO','ALERTA EXCESO DE VELOCIDAD')
			$position_data 				=$this->__EXECUTE($comando_sql);
			#$this->__PRINT_R($position_data);
			#/*
			$aux_descripcion="";
            foreach($position_data as $row)
            {
            	$data_update	=array();
            	$row_new		=$row;
            	$speed_end		="0000-00-00 00:00:00";
            	$speed_start	="0000-00-00 00:00:00";
            	$asunto			="";
            	if($row["speed_max"]>0 and $row["speed"]*1.852>=$row["speed_max"])	
            		$asunto="VELOCIDAD";
            	else if($row["speed"]*1.852>=110)	
            		$asunto="VELOCIDAD";
            	else
            	{
            		#if(!isset($row["descripcion"]))		$row["descripcion"]="";
            		if($row["speed_start"]!="0000-00-00 00:00:00")
            			$speed_end					=$row["devicetime"];            	
            	}
            	$option="";
            	$aux_descripcion=$this->position_description($row,$option);
            	            	
            	if($asunto=="VELOCIDAD")
            	{       
            		$row["event"]			="ALERTA EXCESO DE VELOCIDAD";     		
            		if($row["speed_start"]=="0000-00-00 00:00:00")
            		{            			
            			$descripcion				="
		        			Esta es una alerta de exceso de velocidad
		        			$aux_descripcion
            			";            			            			
            			
            			$speed_start				=$row["devicetime"];
            			$speed_end					="0000-00-00 00:00:00";
            		
            			            				
            			$row_new["speed"]			=$row["speed"]*1.852;
            			
            			/*
            			if(@$row_new["mail_speed"]!="")
            			{
							$option_mail=array(
								"to"		=>@$row_new["mail_speed"],
								"bbc"		=>@$row_new["evigra@gmail.com"],
								"title"		=>"SOLESGPS ".$this->date2." :: Exceso de velocidad"
							);							
							$this->mail_position($row_new,$option_mail);            			
						}
						*/	
            		}	
            	}            	            	
				if($speed_end!="0000-00-00 00:00:00" OR $speed_start!="0000-00-00 00:00:00")
				{					
					$comando_sql="
						UPDATE devices
						SET speed_end='$speed_end', speed_start='$speed_start'							
						WHERE id='{$row["dev_id"]}'
					";		
					$this->__EXECUTE($comando_sql);				
				}            	

    			$menu_id					="2";
    			$submenu_id					="13";
    			$opcion_id					="46";
    			$color						="yellow";
    			
				###################################################
				# ALERTAS #########################################
				###################################################
				
				$descripcion	.="$aux_descripcion";
				#echo $row["descripcion"];
            	if(substr($row["event"],0,5)=="ALERT")
            	{		
					$option_mail=array(
						"to"		=>"evigra@gmail.com",
						"bbc"		=>"evigra@gmail.com",
						"title"		=>"SOLESGPS :: {$row["event"]}"
					);						
            	
            		$comando_sql		="";
            		$PRE_comando_sql	="INSERT INTO alert SET company_id	={$row["company_id"]}, fechaEvento	='{$row["devicetime"]}', asunto='{$row["descripcion"]}',";
            		if($speed_end!="0000-00-00 00:00:00")            	
            		{	# VELOCIDAD
						$comando_sql="
							$PRE_comando_sql
							descripcion='{$descripcion}',														
							menu_id		='$menu_id',
							submenu_id	='$submenu_id',
							opcion_id	='$opcion_id',
							color		='$color'
						";		
					}	
            		else if($row["event"]=="ALERTA ALARMA DE BATERIA")
            		{	# BATERIA BAJA
            			$color			="yellow";
						$comando_sql="
							$PRE_comando_sql
							descripcion='{$descripcion}',
							menu_id		='$menu_id',
							submenu_id	='$submenu_id',
							opcion_id	='$opcion_id',
							color		='$color'
						";		
					}	
            		else if($row["event"]=="ALERTA SOS PRESIONADO")
            		{	# BATERIA BAJA
            			$color			="red";
            			$descripcion	="
		        			Esta es una alerta por bateria baja
		        			$aux_descripcion
            			";            			            			
						$comando_sql="
							$PRE_comando_sql
							descripcion='{$descripcion}',
							menu_id		='$menu_id',
							submenu_id	='$submenu_id',
							opcion_id	='$opcion_id',
							color		='$color'
						";														
					}	
            		else if($row["event"]=="ALERTA BATERIA BAJA")
            		{	# BATERIA BAJA
            			$color			="red";
            			$descripcion	="
		        			Esta es una alerta por bateria baja
		        			$aux_descripcion
            			";            			            			
						$comando_sql="
							$PRE_comando_sql
							descripcion='{$descripcion}',
							menu_id		='$menu_id',
							submenu_id	='$submenu_id',
							opcion_id	='$opcion_id',
							color		='$color'
						";		
					}	

            		else
            		{	# CUALQUIER OTRO
            			$descripcion	="
		        			Esta es una alerta automatica
		        			$aux_descripcion
            			";            			            			

						$comando_sql="
							$PRE_comando_sql
							descripcion='{$descripcion}',
							menu_id		='$menu_id',
							submenu_id	='$submenu_id',
							opcion_id	='$opcion_id',
							color		='$color'
						";		
					}	
					
					if($comando_sql!="")
					{
						$this->__EXECUTE($comando_sql);
					}	
					#$this->mail_position($row_new,$option_mail);					
            	}	            	
                $this->sys_primary_id		=$row["pos_id"];
                $data_update["leido"]		="1";
                $data_update["status"]		="1";
                $data_update["geofence"]	="{$this->geofences($row)}";
                
                $this->travels($row);
                
                
                if($row["event"]=="REPORTE DE TIEMPO")
                {                	                	
                	if($data_update["geofence"]!="")
	            	    $data_update["event"]		="REPORTE POR GEOCERCA";
				}
                if($data_update["event"]=="")
	                $data_update["event"]		="{$row["event"]}";
                

                $option_position			=array();

                $this->__SAVE($data_update,$option_position);
            }						
            #*/
		}
		public function mail_position($position=NULL,$option=NULL)
    	{		 
			if(is_null($option))			$option				=array();
			
			if(!isset($option["to"]))		$option["to"]		="evigra@gmail.com";
			if(!isset($option["title"]))	$option["title"]	="SolesGPS Mail automatico";
			
			$mensaje   = $this->position_description($position,$option);
			
			$option["html"]	=$mensaje;
			
			$this->send_mail($option);
		}
		public function position_description($position=NULL,$option)
    	{		 
    		$title="";
    		if(isset($option["title"]))	$title=$option["title"];
    		
			$nombre_fichero 	= "http://maps.googleapis.com/maps/api/streetview?size=600x300&location={$position["latitude"]},{$position["longitude"]}";			
			$img_streetview= "<img border=\"0\" alt=\"IMAGEN\" src=\"$nombre_fichero\"><br>";
	
			$localizacion="";
			if($position["address"]!="")	$localizacion=$position["address"];
			else							$localizacion=$position["geofence"];
			
			$ruta="/alert_mail/&a=".md5($position["pos_id"]);

			if($position["file_id"]>0)			
				$logo="
					<tr><td colspan=\"2\"><img width=\"50\" border=\"0\" alt=\"\" src=\"http://solesgps.com/modulos/files/file/{$position["file_id"]}.{$position["extension"]}\"></td>		<td colspan=\"2\"></td></tr>
				";
			else $logo="";
			
			$return   = "			
				<html>
					<body body=\"background-color:#bbb;\">					
						<div style=\"width:100%;\">
							<center>																				
								<table style=\"margin:5px; background-color:#aaa;\">									
									$logo
									<tr><td><b>Dispositivo</b></td>		<td>{$position["dispo"]}</td>		<td><b>Identificador</b></td>	<td>{$position["placas"]}</td></tr>
									<tr><td><b>Localizacion</b></td>	<td>{$localizacion}</td>			<td><b>Velocidad</b></td>		<td>{$position["speed"]}</td></tr>
									<tr><td><b>Fecha</b></td>			<td>{$position["devicetime"]}</td>	<td><b>Evento</b></td>			<td>{$position["event"]}</td> </tr>
									<tr>
										<td colspan=\"4\">
											<a href=\"{$position["sistema_web"]}$ruta\">
											$img_streetview
					        				<img border=\"0\" alt=\"IMAGEN\" src=\"http://maps.googleapis.com/maps/api/staticmap?zoom=16&size=600x300&maptype=roadmap&markers=color:red%7C{$position["latitude"]},{$position["longitude"]}\">		
					        				</a>
										</td>
									</tr>
								</table>									
							</center>		
						</div>									
					</body>	
				</html>				
			";								
			return $return;
		}

		public function geofences($position=NULL)
    	{		     		
    		if(!isset($_SESSION["geofence"]))	
    			$_SESSION["geofence"]=array();
    		#if(!isset($_SESSION["geofence"][$position["company_id"]]))	
			{
				$comando_sql				="
					SELECT a.id as aid, a.*, ad.*, ag.*, ag.id as agid, g.*, g.id as gid
					FROM 
						alerts a join
						alerts_device ad on ad.alerts_id=a.id and ad.status=1 join
						alerts_geofence ag on ag.alerts_id=a.id and ag.status=1 join
						geofences g on g.id=ag.geofence_id
					WHERE 1=1
						AND a.status='activo'	
					 	AND a.company_id={$position["company_id"]}
		                AND (
							a.geofence_in!=''
		                    OR a.geofence_out!=''
		                )    					 
				";
				#echo "<br><br>$comando_sql";
				$geofence_data 				=$this->__EXECUTE($comando_sql);
				
				$_SESSION["geofence"][$position["company_id"]]=$geofence_data;									
			}
			$geofence_data					=$_SESSION["geofence"][$position["company_id"]];
			$return="";			
			#$this->__PRINT_R($geofence_data);
			#$this->__PRINT_R($position);
            foreach($geofence_data as $row)
            { 
            	# LA POSICION DEL DISPOSITIVO DEBE CONINCIDIR CON LAS GEOCERCAS ASIGNADAS
            	if($row["device_id"]==$position["dev_id"])
            	{
            		#echo "GEOCERCA >>>>>>>>>>>>>>>>>>> <br>";
		        	$row["area"]	=substr($row["area"],9,strlen($row["area"])-11);
		        	#$points		=str_replace(",", " ", $row["area"]);            	
		        	$polygon		=explode(",",$row["area"]);
		        	$total			=count($polygon)-1;
		        	if(count($polygon)>0)
		        	{
				    	#unset($polygon[$total]);            	            	
				    	$respueta	=$this->pointInPolygon("{$position["latitude"]} {$position["longitude"]}", $polygon);
				    	#$respueta	=$this->pointInPolygon("1 1", $polygon);
				    	#echo "RESPUESTA: $respueta<br>";
						$comando_sql="
							select * from devices_geofences 
							WHERE 1=1
								AND deviceid	={$position["dev_id"]} 
								AND geofenceid	={$row["gid"]}
								AND alertid		={$row["aid"]}  
								AND STATUS		='1' 						
								AND tipo		='GEOFENCES'
								AND del IS NULL
						";				    	
						$devicegeofence_data 		=$this->__EXECUTE($comando_sql);
						#echo "<br><br>$comando_sql";
						#$this->__PRINT_R($devicegeofence_data);
												
				    	if($respueta=="DENTRO")
				    	{   		        		
				    		#echo "DENTRO >>>>>>>>> <br>";
							$return="";					
							if(count($devicegeofence_data)==0)
							{
								$comando_sql="
									INSERT INTO devices_geofences SET 
										deviceid	={$position["dev_id"]}, 
										geofenceid	={$row["id"]}, 
										alertid		={$row["aid"]},  
										time		='{$position["devicetime"]}',
										positionid	='{$position["pos_id"]}',
										tipo		='GEOFENCES',
										status		=1
								";
								#echo "<br>DENTRO INS :: $comando_sql";
								$this->__EXECUTE($comando_sql);

								$option_mail=array(
									"to"		=>$row["geofence_in"],
									"bbc"		=>$row["geofence_email_in"],
									"title"		=>"SOLESGPS ".$this->date2." :: Entrada a Geocercas"
								);
								$position["geofence"]=$row["name"];
								$this->mail_position($position,$option_mail);
							
							}    					
				    		$return.="{$row["name"]}";
				    	}
				    	else if($respueta=="AFUERA")
				    	{        		        		
				    		#echo "AFUERA >>>>>>>>> <br>";							
							if(count($devicegeofence_data)>0)
							{
								$comando_sql	="INSERT INTO devices_geofences SET 
									deviceid	={$position["dev_id"]}, 
									geofenceid	={$row["id"]}, 
									time		='{$position["devicetime"]}', 
									alertid		={$row["aid"]},  
									positionid	='{$position["pos_id"]}',
									tipo		='GEOFENCES',
									status		=0
								";
								#echo "<br>AFUERA INS :: $comando_sql";
								
								$comando_sql	="UPDATE devices_geofences SET 
										time_end='{$position["devicetime"]}', 
										del=1 
									WHERE 1=1
										and deviceid={$position["dev_id"]} 
										AND geofenceid={$row["gid"]} 
										AND alertid={$row["aid"]}
										AND tipo ='GEOFENCES'
								";
								#echo "<br>AFUERA UPD :: $comando_sql";
								$this->__EXECUTE($comando_sql);
								
								$option_mail=array(
									"to"		=>@$row["geofence_out"],
									"bbc"		=>@$row["geofence_email_out"],
									"title"		=>"SOLESGPS ".$this->date2." :: Salida de Geocercas"
								);
								$position["geofence"]=$row["name"];
								$this->mail_position($position,$option_mail);
								$return.="{$row["name"]}";

							}
				    	}  
		        	}          	
				}
			}	
			return $return;
		}		
		public function crear_route($points, $position)
    	{		     		
    		$ida	=array();
    		$vuelta	=array();
    		$anterior="";
    		    		
    		$latitud_mayor	=$position["latitude"]+0.05;
    		$latitud_menor	=$position["latitude"]-0.05;
    		
    		$longitud_mayor	=$position["longitude"]+0.05;
    		$longitud_menor	=$position["longitude"]-0.05;
    		    		
            foreach($points as $point)
            { 
            	$t_punto_actual	=@explode(" ",$point);
            	
            	if($latitud_menor<$t_punto_actual[0] AND $latitud_mayor>$t_punto_actual[0] AND $longitud_menor<$t_punto_actual[1] AND $longitud_mayor>$t_punto_actual[1])
            	{	#echo "<br>$latitud_menor < {$t_punto_actual[0]} > $latitud_mayor";            		
					if(@$anterior=="")		
					{
						$anterior=$t_punto_actual;
					}
					else
					{			
						$nuevo	=$t_punto_actual;

						$origen		=array("lat" => $anterior[0], "lng" => $anterior[1]);
						$destino	=array("lat" => $nuevo[0], "lng" => $nuevo[1]);
						$response1 =  \GeometryLibrary\SphericalUtil::computeHeading($origen, $destino);
		
					  	$p1 =  \GeometryLibrary\SphericalUtil::computeOffset(array("lat" => $nuevo[0], "lng" => $nuevo[1]), 60, $response1 - 90);
					  	$p2 =  \GeometryLibrary\SphericalUtil::computeOffset(array("lat" => $nuevo[0], "lng" => $nuevo[1]), 60, $response1 + 90);
					  	
						$ida[]	=$p1["lat"]." ".$p1["lng"];
						array_unshift($vuelta, $p2["lat"]." ".$p2["lng"]);

						$anterior=$nuevo;            	
					}
    			}
			}
			array_merge($ida, $vuelta);			
			$ida[]=$ida[0];
			
			return $ida;
		}		
		
		
		
		
		public function travels($position=NULL)
    	{		     		
    		if(!isset($_SESSION["travels"]))	
    			$_SESSION["travels"]=array();
    		#if(!isset($_SESSION["geofence"][$position["company_id"]]))	
			{
				$comando_sql				="
					select 
						r.*, r.id as gid, r.id as aid
					from 
						travels t join route r on r.id=t.route_id
						
					where  1=1
						AND t.company_id={$position["company_id"]}
						AND left(sysdate(),10) BETWEEN t.inicio AND t.fin					
				";
				#echo "<br><br>$comando_sql >>>>>>>>>>>>>>>>";
				$geofence_data 				=$this->__EXECUTE($comando_sql);
				
				$_SESSION["travels"][$position["company_id"]]=$geofence_data;									
			}
			$geofence_data					=$_SESSION["travels"][$position["company_id"]];
			
			#$this->__PRINT_R($geofence_data);
			$return="";			
            foreach($geofence_data as $row)
            {
            	#echo "<br><br>$comando_sql >>>>>>>>>>>>>>>>";
            	#echo "<br>recorre routas"; 
            	# LA POSICION DEL DISPOSITIVO DEBE CONINCIDIR CON LAS GEOCERCAS ASIGNADAS
            	#if($row["device_id"]==$position["dev_id"])
            	#$this->__PRINT_r($row);
            	{
            		$points_route	=explode(",",$row["points_route"]);
            		#echo "<br>RUTA=".count($points_route);
		        	$polygon		=$this->crear_route($points_route, $position);
		        	#echo "<br>POLIGONO=".count($polygon);
		        	$total			=count($polygon)-1;
		        	if(count($polygon)>0)
		        	{		        
		        		#echo "<br>ANTES RESPUESTA=><br><br>";
				    	$respueta	=$this->pointInPolygon("{$position["latitude"]} {$position["longitude"]}", $polygon);
				    	#echo "<br>RESPUESTA=>$respueta<br><br>";
				    	
						$comando_sql="
							select * from devices_geofences 
							WHERE 1=1
								AND deviceid	={$position["dev_id"]} 
								AND geofenceid	={$row["gid"]}
								AND alertid		={$row["aid"]}  
								AND STATUS		='1' 						
								AND del IS NULL
								AND tipo		='TRAVEL'
						";				

						$devicegeofence_data 		=$this->__EXECUTE($comando_sql);
				    	if($respueta=="DENTRO")
				    	{   		        		
							$return="";					
							if(count($devicegeofence_data)==0)
							{
								$comando_sql="
									INSERT INTO devices_geofences SET 
										deviceid	={$position["dev_id"]}, 
										geofenceid	={$row["gid"]}, 
										alertid		={$row["aid"]},  
										time		='{$position["devicetime"]}',
										positionid	='{$position["pos_id"]}',
										tipo		='TRAVEL',
										status		=1
								";
								$this->__EXECUTE($comando_sql);
								$option_mail=array(
									"to"		=>"evigra@gmail.com",
									"title"		=>"SOLESGPS ".$this->date2." :: Entrando a Ruta"
								);
								$position["geofence"]=$row["name"];
								$this->mail_position($position,$option_mail);
							}    					
				    		$return.="{$row["name"]}";
				    	}
				    	else if($respueta=="AFUERA")
				    	{        		        		
							if(count($devicegeofence_data)>0)
							{
								$comando_sql	="INSERT INTO devices_geofences SET 
									deviceid	={$position["dev_id"]}, 
									geofenceid	={$row["gid"]}, 
									time		='{$position["devicetime"]}', 
									alertid		={$row["aid"]},  
									positionid	='{$position["pos_id"]}',
									tipo		='TRAVEL',
									status		=0
								";
								
								$comando_sql	="UPDATE devices_geofences SET 
										time_end='{$position["devicetime"]}', 
										del=1 
									WHERE 1=1
										and deviceid={$position["dev_id"]} 
										AND geofenceid={$row["gid"]} 
										AND alertid={$row["aid"]}
										AND tipo='TRAVEL',
								";
								$this->__EXECUTE($comando_sql);
								$this->__PRINT_R($comando_sql);
								$option_mail=array(
									"to"		=>"evigra@gmail.com",
									"title"		=>"SOLESGPS ".$this->date2." :: ALERTA Salida de ruta"
								);
								$position["geofence"]="SALIDA DE RUTA";
								$this->mail_position($position,$option_mail);
								$return.="{$row["name"]}";

							}
				    	}  
		        	}          	
				}
			}	
			return $return;
		}		

		public function position($option=NULL)
    	{
    		if(is_null($option))	$option=array();

			if(!isset($option["from"]))
				$option["from"]		="
					positions p	 	join 
					devices d 		on p.deviceid=d.id
				";	
			$option["where"][]	="company_id={$_SESSION["company"]["id"]}";
			if(!isset($option["order"]))
				$option["order"]	="date DESC";
			#$option["echo"]		="POSITION";
			
			return $this->__VIEW_REPORT($option);						
		}		
		public function distancias($option=NULL)
    	{
    		if(is_null($option))	$option=array();

			$option["select"]						=array();
		
			$option["select"][]						="name";
			$option["select"]["DATE(servertime)"]	="date";
			$option["select"]["min(truncate((extract_JSON(p.attributes,'totalDistance')/1000) +d.odometro_inicial ,1) )"]			="start";
			$option["select"]["max(truncate((extract_JSON(p.attributes,'totalDistance')/1000) +d.odometro_inicial ,1) )"]			="end";
			$option["select"]["max(truncate((extract_JSON(p.attributes,'totalDistance')/1000) +d.odometro_inicial ,1) )-min(truncate((extract_JSON(p.attributes,'totalDistance')/1000) +d.odometro_inicial ,1) )"]				="distance";

			$option["group"]	="name,left(DATE_SUB(p.devicetime,INTERVAL 6 HOUR),10)";
			
			$option["from"]		="
				positions p	 							join 
				devices d 		on p.deviceid=d.id
			";	
			$option["where"][]	="company_id={$_SESSION["company"]["id"]}";

			if(!isset($option["order"]))
				$option["order"]	="date DESC";
			#$option["echo"]		="POSITION";
			
			return $this->__VIEW_REPORT($option);						
		}		

		public function time_position($option=NULL)
    	{
    		if(is_null($option))	$option=array();
			#$option["echo"]	="TIME POSITION";
			if(!isset($option))				$option=array();
			if(!isset($option["select"]))	$option["select"]		=array();

			$option["select"][]						="p.id";
			#$option["select"]["device"]				="d.id";
			$option["select"][]						="name";
			$option["select"][]						="latitude";
			$option["select"][]						="longitude";
			$option["select"][]						="speed";
			$option["select"]["DATE(servertime)"]	="date";
			$option["select"]["TIMEDIFF(MAX(TIME(DATE_SUB(devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR))),MIN(TIME(DATE_SUB(devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR))))"]			="time";
			$option["select"]["MIN(TIME(DATE_SUB(devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR)))"]			="start";
			$option["select"]["MAX(TIME(DATE_SUB(devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR)))"]			="end";
			$option["select"][]						="address";
			$option["select"]["event"]				="other";

			if(!isset($option["group"]))
				$option["group"]	="CONCAT(longitude,latitude,course),DATE(DATE_SUB(devicetime,INTERVAL {$_SESSION["user"]["huso_h"]} HOUR))";
			if(!isset($option["having"]))	
				$option["having"]	=array("time > TIME(SEC_TO_TIME(60))");
			$option["order"]	="date DESC";
	
			return $this->position($option);						
		}		

		#################################################################################
		function pointInPolygon($point, $polygon, $pointOnVertex = true) 
		{
			#echo "pasa ";
			#$point="70 40";
			#$polygon = array("-50 30","50 70","100 50","80 10","110 -10","110 -30","-20 -50","-30 -40","10 -10","-10 10","-30 -20","-50 30");
			
			#$this->__PRINT_R($point);
			#$this->__PRINT_R($polygon);
			
			$this->pointOnVertex = $pointOnVertex;

			// Transformar la cadena de coordenadas en matrices con valores "x" e "y"
			#echo "<br>PUNTO";
			$point = $this->pointStringToCoordinates($point);
			$vertices = array();
			foreach ($polygon as $vertex) 
			{
				#echo "<br>POLIGONO";
				$vertices[] = $this->pointStringToCoordinates($vertex);
			}

			// Checar si el punto se encuentra exactamente en un vértice
			if ($this->pointOnVertex == true and $this->pointOnVertex($point, $vertices) == true) 
			{
				return "vertice";
			}

			// Checar si el punto está adentro del poligono o en el borde
			$intersections = 0;
			$vertices_count = count($vertices);

			for ($i=1; $i < $vertices_count; $i++) 
			{
				$vertex1 = $vertices[$i-1];
				$vertex2 = $vertices[$i];
				if ($vertex1['y'] == $vertex2['y'] and $vertex1['y'] == $point['y'] and $point['x'] > min($vertex1['x'], $vertex2['x']) and $point['x'] < max($vertex1['x'], $vertex2['x'])) 
				{ // Checar si el punto está en un segmento horizontal
					return "BORDE";
				}
				if ($point['y'] > min($vertex1['y'], $vertex2['y']) and $point['y'] <= max($vertex1['y'], $vertex2['y']) and $point['x'] <= max($vertex1['x'], $vertex2['x']) and $vertex1['y'] != $vertex2['y']) 
				{
					$xinters = ($point['y'] - $vertex1['y']) * ($vertex2['x'] - $vertex1['x']) / ($vertex2['y'] - $vertex1['y']) + $vertex1['x'];
					if ($xinters == $point['x']) 
					{ // Checar si el punto está en un segmento (otro que horizontal)
						return "BORDE";
					}
					if ($vertex1['x'] == $vertex2['x'] || $point['x'] <= $xinters) 
					{
						$intersections++;
					}
				}
			}
			// Si el número de intersecciones es impar, el punto está dentro del poligono.
			if ($intersections % 2 != 0) 
			{
				return "DENTRO";
			} 
			else 
			{
				return "AFUERA";
			}
		}
		##############################################################################
		function pointOnVertex($point, $vertices) 
		{
			foreach($vertices as $vertex) 
			{
				if ($point == $vertex) 
				{
					return true;
				}
			}

		}
		##############################################################################
		function pointStringToCoordinates($pointString) 
		{
			$pointString=trim($pointString);
			#$this->__PRINT_R($pointString);
			$coordinates = explode(" ", $pointString);
			#$this->__PRINT_R($coordinates);
			return array("x" => $coordinates[0], "y" => $coordinates[1]);
		}		
	}
?>

