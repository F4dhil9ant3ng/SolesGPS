<?php
	#if(file_exists("../menu/modelo.php")) require_once("../menu/modelo.php");
	
	class alerts extends general
	{   
		##############################################################################	
		##  Propiedades	
		##############################################################################
		var $sys_fields		=array(
			"id"	    =>array(
			    "title"             => "id",
			    "showTitle"         => "si",
			    "type"              => "primary key",
			    "default"           => "",
			    "value"             => "",			    
			),
			"company_id"	    =>array(
			    "title"             => "Compania",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",
			    /*
			    "relation"          => "one2many",			    
			    "class_name"       	=> "company",
			    "class_path"        => "modulos/company/modelo.php",
			    "class_field_o"    	=> "company_id",
			    "class_field_m"    	=> "id",			    			    
			    */
			),			
			"name"	    =>array(
			    "title"             => "Alerta",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",			    
			),
			"geofence_in"	    =>array(
			    "title"             => "Email de entrada",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",			    
			),
			"geofence_out"	    =>array(
			    "title"             => "Email de salida",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "default"           => "",
			    "value"             => "",			    
			),
			
			"event"	    =>array(
			    "title"             => "Evento",
			    "showTitle"         => "si",
			    "type"              => "select",
			    "default"           => "",
			    "value"             => "",			    
			    "source"			=>array(
			    	"ingeofence"		=>	"Entrada a geocerca",
			    	"outgeofence"		=>	"Salida de geocerca",
			    ),				    	    

			),
			"status"	    =>array(
			    "title"             => "Estatus",
			    "showTitle"         => "si",
			    "type"              => "select",
			    "default"           => "",
			    "value"             => "",		
			    "source"			=>array(
			    	"activo"		=>	"Activa",
			    	"inativo"		=>	"Inactivo",
			    ),				    	    
			),			
			"geofences_ids"	    =>array(
			    "title"             => "Menu",
			    "showTitle"         => "si",
			    "type"              => "input",
			    "relation"          => "one2many",			    
			    "class_name"       	=> "geofences",
			    /*
			    #"class_path"        => "modulos/geofences/modelo.php",
			    #"class_field_l"    	=> "name",				# Label
			    "class_field_o"    	=> "id",					# Origen
			    "class_field_m"    	=> "geofences_id",			# Destino
			    "value"             => "",			    			    
			    */
			),			
			"devices_ids"	    =>array(
			    "title"             => "Menu",
			    "showTitle"         => "si",
			    "type"              => "input",			    
			    "relation"          => "one2many",			    
			    "class_name"       	=> "devices",
			    /*
			    #"class_path"        => "modulos/devices/modelo.php",
			    #"class_field_l"    	=> "name",				# Label
			    "class_field_o"    	=> "id",					# Origen
			    "class_field_m"    	=> "devices_id",			# Destino
			    "class_echo"    	=> "devices_id",			# Destino
			    "value"             => "",			    
			    */
			),			
		);				
		##############################################################################	
		##  Metodos	
		##############################################################################

        
		public function __CONSTRUCT()
		{
			#$this->menu_obj=new menu();
			parent::__CONSTRUCT();

		}
		public function device($option=NULL)		
    	{	
			$comando_sql		="SELECT * FROM alerts_device ag WHERE device_id={$option["device_id"]} AND alerts_id='{$option["alerts_id"]}'";
			#echo $comando_sql;
			return $this->__EXECUTE($comando_sql);
		}
		public function save_device($datas,$alert_id=NULL)		
    	{	
			$devices=$this->devices_ids_obj->devices_data();
			
    		foreach($devices as $device)
    		{
    			$status ="status=0";
    			if(is_array(@$datas["devices_ids"]))
    			{
    				if(array_key_exists(@$device["id"],@$datas["devices_ids"])) 		$status ="status=1";
    				else											   					$status ="status=0";
    			}	
    			
				$alerts_device_option=array(
					"alerts_id"		=>"$alert_id",
					"device_id"		=>"{$device["id"]}",
				);    	    		    	    		
				$alerts_device_data	=$this->device($alerts_device_option);
				
				#$this->__PRINT_R($alerts_device_data);	
				$status.=", device_id='{$device["id"]}', alerts_id='$alert_id'";
				if(count($alerts_device_data)>0)		$comando_sql="UPDATE alerts_device SET $status WHERE id='{$alerts_device_data[0]["id"]}'";
				else									$comando_sql="INSERT INTO alerts_device SET $status";
				
				$this->__EXECUTE($comando_sql);
    		}    	
		}
		
		public function geofence($option=NULL)		
    	{	    		
			$comando_sql		="SELECT * FROM alerts_geofence ag WHERE geofence_id={$option["geofence_id"]} AND alerts_id='{$option["alerts_id"]}'";
			return $this->__EXECUTE($comando_sql);
		}
		public function save_geofence($datas,$alert_id=NULL)		
    	{	
			$geofences=$this->geofences_ids_obj->geofences_data();
    		foreach($geofences as $geofence)
    		{
    			$status ="status=0";
    			if(is_array(@$datas["geofences_ids"]))
    			{
    				if(array_key_exists($geofence["id"],@$datas["geofences_ids"])) 	$status ="status=1";
    				else											   				$status ="status=0";
    			}	
    			
				$alerts_geofence_option=array(
					"alerts_id"		=>"$alert_id",
					"geofence_id"	=>"{$geofence["id"]}",
				);    	    		    	    		
				$alerts_geofence_data	=$this->geofence($alerts_geofence_option);
				
				$status.=", geofence_id='{$geofence["id"]}', alerts_id='$alert_id'";
				if(count($alerts_geofence_data)>0)		$comando_sql="UPDATE alerts_geofence SET $status WHERE id='{$alerts_geofence_data[0]["id"]}'";
				else									$comando_sql="INSERT INTO alerts_geofence SET $status";
				
				$this->__EXECUTE($comando_sql);
    		}    	
		}
   		public function __SAVE($datas=NULL,$option=NULL)
    	{
    		## GUARDAR USUARIO
    		#$option["echo"]="ALERTS";
    		$datas["company_id"]    =$_SESSION["company"]["id"];
    		
    		/*
    		$option=array(
    			"e_open"=>"SAVE alerts",
    			"e_close"=>"SAVE alerts",
    		);
    		*/
    	    $alert_id				=parent::__SAVE($datas,$option);
    	    
    	    #$this->__PRINT_R($alert_id);
    	    
			$this->save_geofence($datas,$alert_id);
			$this->save_device($datas,$alert_id);
    	    #echo "<br>USUARIO=$user_id<br>";
    	    ## GUARDAR PERFILES DE USUARIO
		}				
		public function alerts($option=NULL)		
    	{	
    		if(is_null($option))	$option=array();
    		
			$option["select"]	=array(
				"a.*",
			);
			$option["from"]		="alerts a";
			if(!isset($option["where"]))    $option["where"]    =array();
			
			$option["where"][]  ="a.company_id={$_SESSION["company"]["id"]}";
			#$option["order"]	="menu_name asc, nivel asc";
			
			$return =$this->__VIEW_REPORT($option);    				
			return $return;
		}
		
	}
?>

